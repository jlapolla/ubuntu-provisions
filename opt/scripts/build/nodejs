#!/bin/sh
#
# Build Node.js from source.
#
# SYNOPSIS
# nodejs OUTPUT [VERSION]
#
# DESCRIPTION
# Download Node.js source code, compile and build Node.js, and package
# compiled binaries in a distribution tarball. Distribution tarball will
# be created at the path specified by OUTPUT. Optionally, specify a
# VERSION of Node.js to build.

set -e

# Check for g++.
g++ --version > /dev/null

OUTPUT="`pwd`/$1"
VERSION="$2"
TEMPDIR="`mktemp -d`"

cd "$TEMPDIR"
if [ -n "$VERSION" ] ; then
	git clone -b "$VERSION" --depth 1 https://github.com/joyent/node.git .
else
	git clone --depth 1 https://github.com/joyent/node.git .
fi
./configure
make
make test
INSTDIR="`mktemp -d`"
make DESTDIR="$INSTDIR" install
cd "$INSTDIR"
find . ! -type d -print0 | xargs -0 tar -czf "$OUTPUT"
cd
rm -rf "$TEMPDIR" "$INSTDIR"
